"use strict";!function(){var t=function(){var t=this;t.getOptions=function(){t.container=document.querySelector(".shopList"),t.content=document.querySelector(".shopListMain__content"),t.template=document.querySelector("#shopListItem").innerHTML,t.openFooterBtn=document.querySelector(".shopListMain__open"),t.footer=document.querySelector(".shopListFooter"),t.input=document.querySelector(".shopListFooter__input"),t.hidden=document.querySelector(".shopListFooter__hidden"),t.form=document.querySelector(".shopListFooter__form"),t.submitBtn=document.querySelector(".shopListFooter__btn.shopListFooter__btn_type_submit"),t.shopList=[]},t.loadData=function(){var e=localStorage.getItem("shopList");e&&(t.shopList=JSON.parse(e))},t.setupListener=function(){t.openFooterBtn.addEventListener("pointerdown",function(e){e.preventDefault(),t.openFooter()}),t.footer.addEventListener("pointerdown",function(e){e.preventDefault(),e.target===t.footer&&0===t.input.value.length&&t.closeFooter()}),t.input.addEventListener("keyup",t.handleKeyUp),t.form.addEventListener("submit",t.submit),t.submitBtn.addEventListener("pointerdown",t.handleSubmitBtn),t.container.addEventListener("click",t.routeClick)},t.routeClick=function(e){var n=e.target,i="";n.classList.contains("shopListItem__content")?i="toggleItemPanel":n.classList.contains("shopListItem__btn_type_complete")?i="complete":n.classList.contains("shopListItem__btn_type_edit")&&(i="edit"),i&&t[i](e)},t.toggleItemPanel=function(e){var n=e.target;if(n.classList.contains("shopListItem__content")){var i=n.getAttribute("data-id");i&&(t.shopList=t.shopList.map(function(t){return t.id==i&&(t.isOpen=!t.isOpen),t}),t.render(),t.updateLocalStorage())}},t.complete=function(e){var n=e.target,i=n.getAttribute("data-id");i&&(t.shopList=t.shopList.filter(function(t){return t.id!=i}),t.render(),t.updateLocalStorage())},t.edit=function(e){var n=e.target,i=n.getAttribute("data-id"),o=t.shopList.find(function(t){return t.id==i});i&&o&&(t.input.id="",t.input.value=o.title,t.hidden.value=i,t.container.classList.add("shopList_state_valid"),t.openFooter())},t.openFooter=function(){t.container.classList.add("shopList_state_add"),setTimeout(function(){t.initFocus()},300)},t.closeFooter=function(){t.hideKeyboard(),setTimeout(function(){t.container.classList.remove("shopList_state_add")},800)},t.hideKeyboard=function(){Keyboard&&Keyboard.hide()},t.handleKeyUp=function(){var e=t.input.value,n=e.length,i=n>0?"add":"remove";t.container.classList[i]("shopList_state_valid")},t.handleSubmitBtn=function(e){e.preventDefault(),t.submit()},t.initFocus=function(){t.input.focus()},t.submit=function(e){e&&e.preventDefault();var n=t.input.value,i=t.hidden.value,o=n.length;if(0===o)return!1;var s=(t.shopList.length,i?i:t.shopList.length>=1?t.shopList[t.shopList.length-1].id+1:0),r=!1,a=t.shopList.find(function(t){return t.id==s});a?(a.title=n,t.closeFooter()):t.shopList.push({id:s,title:n,isOpen:r}),t.reset(),t.render(),t.updateLocalStorage()},t.reset=function(){t.form.reset(),t.input.id="shopValue",t.hidden.value="",t.container.classList.remove("shopList_state_valid")},t.render=function(){var e=document.createElement("ul");e.classList.add("shopListMain__list"),t.shopList.forEach(function(n){var i=document.createElement("li");i.classList.add("shopListMain__item"),i.innerHTML=t.template,i.querySelector(".shopListItem__content").setAttribute("data-id",n.id),i.querySelector(".shopListItem__content").innerHTML=n.title,i.querySelector(".shopListItem__btn_type_complete").setAttribute("data-id",n.id),i.querySelector(".shopListItem__btn_type_edit").setAttribute("data-id",n.id),n.isOpen&&i.querySelector(".shopListItem").classList.add("shopListItem_state_open"),e.appendChild(i)}),t.content.innerHTML="",t.content.appendChild(e)},t.updateLocalStorage=function(){var e=JSON.stringify(t.shopList);localStorage.setItem("shopList",e)},t.init=function(){t.getOptions(),t.setupListener(),t.loadData(),t.render(),t.hideKeyboard()}},e=new t;document.addEventListener("deviceready",function(){return e.init()})}();
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1haW4ubWluLmpzIiwic2hvcExpc3Qvc2hvcExpc3QuanMiXSwibmFtZXMiOlsiU2hvcExpc3QiLCJzZWxmIiwidGhpcyIsImdldE9wdGlvbnMiLCJjb250YWluZXIiLCJkb2N1bWVudCIsInF1ZXJ5U2VsZWN0b3IiLCJjb250ZW50IiwidGVtcGxhdGUiLCJpbm5lckhUTUwiLCJvcGVuRm9vdGVyQnRuIiwiZm9vdGVyIiwiaW5wdXQiLCJoaWRkZW4iLCJmb3JtIiwic3VibWl0QnRuIiwic2hvcExpc3QiLCJsb2FkRGF0YSIsImxvY2FsRGF0YSIsImxvY2FsU3RvcmFnZSIsImdldEl0ZW0iLCJKU09OIiwicGFyc2UiLCJzZXR1cExpc3RlbmVyIiwiYWRkRXZlbnRMaXN0ZW5lciIsImV2ZW50IiwicHJldmVudERlZmF1bHQiLCJvcGVuRm9vdGVyIiwidGFyZ2V0IiwidmFsdWUiLCJsZW5ndGgiLCJjbG9zZUZvb3RlciIsImhhbmRsZUtleVVwIiwic3VibWl0IiwiaGFuZGxlU3VibWl0QnRuIiwicm91dGVDbGljayIsIm1ldGhvZCIsImNsYXNzTGlzdCIsImNvbnRhaW5zIiwidG9nZ2xlSXRlbVBhbmVsIiwiaWQiLCJnZXRBdHRyaWJ1dGUiLCJtYXAiLCJzaG9wSXRlbSIsImlzT3BlbiIsInJlbmRlciIsInVwZGF0ZUxvY2FsU3RvcmFnZSIsImNvbXBsZXRlIiwiZmlsdGVyIiwiZWRpdCIsImZpbmQiLCJ0aXRsZSIsImFkZCIsInNldFRpbWVvdXQiLCJpbml0Rm9jdXMiLCJoaWRlS2V5Ym9hcmQiLCJyZW1vdmUiLCJLZXlib2FyZCIsImhpZGUiLCJmb2N1cyIsImhpZGRlblZhbHVlIiwiaXRlbSIsInB1c2giLCJyZXNldCIsImNvbnRlbnRMaXN0IiwiY3JlYXRlRWxlbWVudCIsImZvckVhY2giLCJlbGVtZW50Iiwic2V0QXR0cmlidXRlIiwiYXBwZW5kQ2hpbGQiLCJkYXRhIiwic3RyaW5naWZ5Iiwic2V0SXRlbSIsImluaXQiXSwibWFwcGluZ3MiOiJBQUFBLGNDQUEsV0FLQSxHQUFBQSxHQUFBLFdBQ0EsR0FBQUMsR0FBQUMsSUFLQUQsR0FBQUUsV0FBQSxXQUNBRixFQUFBRyxVQUFBQyxTQUFBQyxjQUFBLGFBQ0FMLEVBQUFNLFFBQUFGLFNBQUFDLGNBQUEsMEJBQ0FMLEVBQUFPLFNBQUFILFNBQUFDLGNBQUEsaUJBQUFHLFVBQ0FSLEVBQUFTLGNBQUFMLFNBQUFDLGNBQUEsdUJBQ0FMLEVBQUFVLE9BQUFOLFNBQUFDLGNBQUEsbUJBQ0FMLEVBQUFXLE1BQUFQLFNBQUFDLGNBQUEsMEJBQ0FMLEVBQUFZLE9BQUFSLFNBQUFDLGNBQUEsMkJBQ0FMLEVBQUFhLEtBQUFULFNBQUFDLGNBQUEseUJBQ0FMLEVBQUFjLFVBQUFWLFNBQUFDLGNBQUEsd0RBQ0FMLEVBQUFlLGFBTUFmLEVBQUFnQixTQUFBLFdBQ0EsR0FBQUMsR0FBQUMsYUFBQUMsUUFBQSxXQUVBRixLQUVBakIsRUFBQWUsU0FBQUssS0FBQUMsTUFBQUosS0FRQWpCLEVBQUFzQixjQUFBLFdBQ0F0QixFQUFBUyxjQUFBYyxpQkFBQSxjQUFBLFNBQUFDLEdBQ0FBLEVBQUFDLGlCQUVBekIsRUFBQTBCLGVBRUExQixFQUFBVSxPQUFBYSxpQkFBQSxjQUFBLFNBQUFDLEdBQ0FBLEVBQUFDLGlCQUVBRCxFQUFBRyxTQUFBM0IsRUFBQVUsUUFBQSxJQUFBVixFQUFBVyxNQUFBaUIsTUFBQUMsUUFFQTdCLEVBQUE4QixnQkFJQTlCLEVBQUFXLE1BQUFZLGlCQUFBLFFBQUF2QixFQUFBK0IsYUFDQS9CLEVBQUFhLEtBQUFVLGlCQUFBLFNBQUF2QixFQUFBZ0MsUUFDQWhDLEVBQUFjLFVBQUFTLGlCQUFBLGNBQUF2QixFQUFBaUMsaUJBQ0FqQyxFQUFBRyxVQUFBb0IsaUJBQUEsUUFBQXZCLEVBQUFrQyxhQU9BbEMsRUFBQWtDLFdBQUEsU0FBQVYsR0FDQSxHQUFBRyxHQUFBSCxFQUFBRyxPQUNBUSxFQUFBLEVBRUFSLEdBQUFTLFVBQUFDLFNBQUEseUJBRUFGLEVBQUEsa0JBRUFSLEVBQUFTLFVBQUFDLFNBQUEsbUNBRUFGLEVBQUEsV0FFQVIsRUFBQVMsVUFBQUMsU0FBQSxpQ0FFQUYsRUFBQSxRQUlBQSxHQUVBbkMsRUFBQW1DLEdBQUFYLElBU0F4QixFQUFBc0MsZ0JBQUEsU0FBQWQsR0FDQSxHQUFBRyxHQUFBSCxFQUFBRyxNQUVBLElBQUFBLEVBQUFTLFVBQUFDLFNBQUEseUJBQUEsQ0FFQSxHQUFBRSxHQUFBWixFQUFBYSxhQUFBLFVBRUFELEtBRUF2QyxFQUFBZSxTQUFBZixFQUFBZSxTQUFBMEIsSUFBQSxTQUFBQyxHQU9BLE1BTkFBLEdBQUFILElBQUFBLElBRUFHLEVBQUFDLFFBQUFELEVBQUFDLFFBSUFELElBR0ExQyxFQUFBNEMsU0FDQTVDLEVBQUE2Qyx3QkFXQTdDLEVBQUE4QyxTQUFBLFNBQUF0QixHQUNBLEdBQUFHLEdBQUFILEVBQUFHLE9BQ0FZLEVBQUFaLEVBQUFhLGFBQUEsVUFFQUQsS0FFQXZDLEVBQUFlLFNBQUFmLEVBQUFlLFNBQUFnQyxPQUFBLFNBQUFMLEdBQ0EsTUFBQUEsR0FBQUgsSUFBQUEsSUFJQXZDLEVBQUE0QyxTQUNBNUMsRUFBQTZDLHVCQVNBN0MsRUFBQWdELEtBQUEsU0FBQXhCLEdBQ0EsR0FBQUcsR0FBQUgsRUFBQUcsT0FDQVksRUFBQVosRUFBQWEsYUFBQSxXQUNBWixFQUFBNUIsRUFBQWUsU0FBQWtDLEtBQUEsU0FBQVAsR0FBQSxNQUFBQSxHQUFBSCxJQUFBQSxHQUVBQSxJQUFBWCxJQUVBNUIsRUFBQVcsTUFBQTRCLEdBQUEsR0FDQXZDLEVBQUFXLE1BQUFpQixNQUFBQSxFQUFBc0IsTUFDQWxELEVBQUFZLE9BQUFnQixNQUFBVyxFQUVBdkMsRUFBQUcsVUFBQWlDLFVBQUFlLElBQUEsd0JBQ0FuRCxFQUFBMEIsZUFRQTFCLEVBQUEwQixXQUFBLFdBQ0ExQixFQUFBRyxVQUFBaUMsVUFBQWUsSUFBQSxzQkFFQUMsV0FBQSxXQUNBcEQsRUFBQXFELGFBQ0EsTUFNQXJELEVBQUE4QixZQUFBLFdBQ0E5QixFQUFBc0QsZUFFQUYsV0FBQSxXQUNBcEQsRUFBQUcsVUFBQWlDLFVBQUFtQixPQUFBLHVCQUNBLE1BTUF2RCxFQUFBc0QsYUFBQSxXQUNBRSxVQUVBQSxTQUFBQyxRQVFBekQsRUFBQStCLFlBQUEsV0FDQSxHQUFBSCxHQUFBNUIsRUFBQVcsTUFBQWlCLE1BQ0FDLEVBQUFELEVBQUFDLE9BQ0FNLEVBQUFOLEVBQUEsRUFBQSxNQUFBLFFBRUE3QixHQUFBRyxVQUFBaUMsVUFBQUQsR0FBQSx5QkFPQW5DLEVBQUFpQyxnQkFBQSxTQUFBVCxHQUNBQSxFQUFBQyxpQkFFQXpCLEVBQUFnQyxVQU1BaEMsRUFBQXFELFVBQUEsV0FDQXJELEVBQUFXLE1BQUErQyxTQU9BMUQsRUFBQWdDLE9BQUEsU0FBQVIsR0FDQUEsR0FFQUEsRUFBQUMsZ0JBSUEsSUFBQUcsR0FBQTVCLEVBQUFXLE1BQUFpQixNQUNBK0IsRUFBQTNELEVBQUFZLE9BQUFnQixNQUNBQyxFQUFBRCxFQUFBQyxNQUVBLElBQUEsSUFBQUEsRUFFQSxPQUFBLENBSUEsSUFDQVUsSUFEQXZDLEVBQUFlLFNBQUFjLE9BQ0E4QixFQUFBQSxFQUFBM0QsRUFBQWUsU0FBQWMsUUFBQSxFQUFBN0IsRUFBQWUsU0FBQWYsRUFBQWUsU0FBQWMsT0FBQSxHQUFBVSxHQUFBLEVBQUEsR0FDQUksR0FBQSxFQUNBaUIsRUFBQTVELEVBQUFlLFNBQUFrQyxLQUFBLFNBQUFQLEdBQUEsTUFBQUEsR0FBQUgsSUFBQUEsR0FFQXFCLElBRUFBLEVBQUFWLE1BQUF0QixFQUNBNUIsRUFBQThCLGVBSUE5QixFQUFBZSxTQUFBOEMsTUFDQXRCLEdBQUFBLEVBQ0FXLE1BQUF0QixFQUNBZSxPQUFBQSxJQUtBM0MsRUFBQThELFFBQ0E5RCxFQUFBNEMsU0FDQTVDLEVBQUE2QyxzQkFNQTdDLEVBQUE4RCxNQUFBLFdBQ0E5RCxFQUFBYSxLQUFBaUQsUUFDQTlELEVBQUFXLE1BQUE0QixHQUFBLFlBQ0F2QyxFQUFBWSxPQUFBZ0IsTUFBQSxHQUNBNUIsRUFBQUcsVUFBQWlDLFVBQUFtQixPQUFBLHlCQU1BdkQsRUFBQTRDLE9BQUEsV0FDQSxHQUFBbUIsR0FBQTNELFNBQUE0RCxjQUFBLEtBRUFELEdBQUEzQixVQUFBZSxJQUFBLHNCQUVBbkQsRUFBQWUsU0FBQWtELFFBQUEsU0FBQUwsR0FDQSxHQUFBTSxHQUFBOUQsU0FBQTRELGNBQUEsS0FFQUUsR0FBQTlCLFVBQUFlLElBQUEsc0JBQ0FlLEVBQUExRCxVQUFBUixFQUFBTyxTQUVBMkQsRUFBQTdELGNBQUEsMEJBQUE4RCxhQUFBLFVBQUFQLEVBQUFyQixJQUNBMkIsRUFBQTdELGNBQUEsMEJBQUFHLFVBQUFvRCxFQUFBVixNQUNBZ0IsRUFBQTdELGNBQUEsb0NBQUE4RCxhQUFBLFVBQUFQLEVBQUFyQixJQUNBMkIsRUFBQTdELGNBQUEsZ0NBQUE4RCxhQUFBLFVBQUFQLEVBQUFyQixJQUVBcUIsRUFBQWpCLFFBRUF1QixFQUFBN0QsY0FBQSxpQkFBQStCLFVBQUFlLElBQUEsMkJBSUFZLEVBQUFLLFlBQUFGLEtBR0FsRSxFQUFBTSxRQUFBRSxVQUFBLEdBRUFSLEVBQUFNLFFBQUE4RCxZQUFBTCxJQU1BL0QsRUFBQTZDLG1CQUFBLFdBQ0EsR0FBQXdCLEdBQUFqRCxLQUFBa0QsVUFBQXRFLEVBQUFlLFNBRUFHLGNBQUFxRCxRQUFBLFdBQUFGLElBTUFyRSxFQUFBd0UsS0FBQSxXQUNBeEUsRUFBQUUsYUFDQUYsRUFBQXNCLGdCQUNBdEIsRUFBQWdCLFdBQ0FoQixFQUFBNEMsU0FDQTVDLEVBQUFzRCxpQkFJQXZDLEVBQUEsR0FBQWhCLEVBRUFLLFVBQUFtQixpQkFBQSxjQUFBLFdBQUEsTUFBQVIsR0FBQXlEIiwiZmlsZSI6Im1haW4ubWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG4oZnVuY3Rpb24gKCkge1xuICAgIC8qKlxuICAgICAqIENyZWF0ZXMgYSBuZXcgU2hvcExpc3QgY2xhc3MuXG4gICAgICogQGNsYXNzXG4gICAgICovXG4gICAgdmFyIFNob3BMaXN0ID0gZnVuY3Rpb24gU2hvcExpc3QoKSB7XG4gICAgICAgIHZhciBzZWxmID0gdGhpcztcblxuICAgICAgICAvKipcbiAgICAgICAgICogR2V0IG9wdGlvbnMgZm9yIG1vZHVsZVxuICAgICAgICAgKi9cbiAgICAgICAgc2VsZi5nZXRPcHRpb25zID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgc2VsZi5jb250YWluZXIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcuc2hvcExpc3QnKTtcbiAgICAgICAgICAgIHNlbGYuY29udGVudCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5zaG9wTGlzdE1haW5fX2NvbnRlbnQnKTtcbiAgICAgICAgICAgIHNlbGYudGVtcGxhdGUgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjc2hvcExpc3RJdGVtJykuaW5uZXJIVE1MO1xuICAgICAgICAgICAgc2VsZi5vcGVuRm9vdGVyQnRuID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLnNob3BMaXN0TWFpbl9fb3BlbicpO1xuICAgICAgICAgICAgc2VsZi5mb290ZXIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcuc2hvcExpc3RGb290ZXInKTtcbiAgICAgICAgICAgIHNlbGYuaW5wdXQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcuc2hvcExpc3RGb290ZXJfX2lucHV0Jyk7XG4gICAgICAgICAgICBzZWxmLmhpZGRlbiA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5zaG9wTGlzdEZvb3Rlcl9faGlkZGVuJyk7XG4gICAgICAgICAgICBzZWxmLmZvcm0gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcuc2hvcExpc3RGb290ZXJfX2Zvcm0nKTtcbiAgICAgICAgICAgIHNlbGYuc3VibWl0QnRuID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLnNob3BMaXN0Rm9vdGVyX19idG4uc2hvcExpc3RGb290ZXJfX2J0bl90eXBlX3N1Ym1pdCcpO1xuICAgICAgICAgICAgc2VsZi5zaG9wTGlzdCA9IFtdO1xuICAgICAgICB9O1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBDaGVjayBpZiB0aGVyZSBkYXRhIGluIGxvY2FsIHN0b3JhZ2UgYW5kIGxvYWQgaXRcbiAgICAgICAgICovXG4gICAgICAgIHNlbGYubG9hZERhdGEgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICB2YXIgbG9jYWxEYXRhID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oJ3Nob3BMaXN0Jyk7XG5cbiAgICAgICAgICAgIGlmIChsb2NhbERhdGEpIHtcblxuICAgICAgICAgICAgICAgIHNlbGYuc2hvcExpc3QgPSBKU09OLnBhcnNlKGxvY2FsRGF0YSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEFkZCBldmVudHMgbGlzdGVuZXJzXG4gICAgICAgICAqL1xuICAgICAgICBzZWxmLnNldHVwTGlzdGVuZXIgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBzZWxmLm9wZW5Gb290ZXJCdG4uYWRkRXZlbnRMaXN0ZW5lcigncG9pbnRlcmRvd24nLCBmdW5jdGlvbiAoZXZlbnQpIHtcbiAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuXG4gICAgICAgICAgICAgICAgc2VsZi5vcGVuRm9vdGVyKCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHNlbGYuZm9vdGVyLmFkZEV2ZW50TGlzdGVuZXIoJ3BvaW50ZXJkb3duJywgZnVuY3Rpb24gKGV2ZW50KSB7XG4gICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcblxuICAgICAgICAgICAgICAgIGlmIChldmVudC50YXJnZXQgPT09IHNlbGYuZm9vdGVyICYmIHNlbGYuaW5wdXQudmFsdWUubGVuZ3RoID09PSAwKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgc2VsZi5jbG9zZUZvb3RlcigpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgc2VsZi5pbnB1dC5hZGRFdmVudExpc3RlbmVyKCdrZXl1cCcsIHNlbGYuaGFuZGxlS2V5VXApO1xuICAgICAgICAgICAgc2VsZi5mb3JtLmFkZEV2ZW50TGlzdGVuZXIoJ3N1Ym1pdCcsIHNlbGYuc3VibWl0KTtcbiAgICAgICAgICAgIHNlbGYuc3VibWl0QnRuLmFkZEV2ZW50TGlzdGVuZXIoJ3BvaW50ZXJkb3duJywgc2VsZi5oYW5kbGVTdWJtaXRCdG4pO1xuICAgICAgICAgICAgc2VsZi5jb250YWluZXIuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBzZWxmLnJvdXRlQ2xpY2spO1xuICAgICAgICB9O1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBSb3V0ZXMgY2xpY2sgZXZlbnRcbiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGV2ZW50XG4gICAgICAgICAqL1xuICAgICAgICBzZWxmLnJvdXRlQ2xpY2sgPSBmdW5jdGlvbiAoZXZlbnQpIHtcbiAgICAgICAgICAgIHZhciB0YXJnZXQgPSBldmVudC50YXJnZXQ7XG4gICAgICAgICAgICB2YXIgbWV0aG9kID0gJyc7XG5cbiAgICAgICAgICAgIGlmICh0YXJnZXQuY2xhc3NMaXN0LmNvbnRhaW5zKCdzaG9wTGlzdEl0ZW1fX2NvbnRlbnQnKSkge1xuXG4gICAgICAgICAgICAgICAgbWV0aG9kID0gJ3RvZ2dsZUl0ZW1QYW5lbCc7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHRhcmdldC5jbGFzc0xpc3QuY29udGFpbnMoJ3Nob3BMaXN0SXRlbV9fYnRuX3R5cGVfY29tcGxldGUnKSkge1xuXG4gICAgICAgICAgICAgICAgbWV0aG9kID0gJ2NvbXBsZXRlJztcbiAgICAgICAgICAgIH0gZWxzZSBpZiAodGFyZ2V0LmNsYXNzTGlzdC5jb250YWlucygnc2hvcExpc3RJdGVtX19idG5fdHlwZV9lZGl0JykpIHtcblxuICAgICAgICAgICAgICAgIG1ldGhvZCA9ICdlZGl0JztcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKG1ldGhvZCkge1xuXG4gICAgICAgICAgICAgICAgc2VsZlttZXRob2RdKGV2ZW50KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogVG9nZ2xlIHNob3AgaXRlbSBwYW5lbFxuICAgICAgICAgKiBAcGFyYW0gZXZlbnRcbiAgICAgICAgICovXG4gICAgICAgIHNlbGYudG9nZ2xlSXRlbVBhbmVsID0gZnVuY3Rpb24gKGV2ZW50KSB7XG4gICAgICAgICAgICB2YXIgdGFyZ2V0ID0gZXZlbnQudGFyZ2V0O1xuXG4gICAgICAgICAgICBpZiAodGFyZ2V0LmNsYXNzTGlzdC5jb250YWlucygnc2hvcExpc3RJdGVtX19jb250ZW50JykpIHtcblxuICAgICAgICAgICAgICAgIHZhciBpZCA9IHRhcmdldC5nZXRBdHRyaWJ1dGUoJ2RhdGEtaWQnKTtcblxuICAgICAgICAgICAgICAgIGlmIChpZCkge1xuXG4gICAgICAgICAgICAgICAgICAgIHNlbGYuc2hvcExpc3QgPSBzZWxmLnNob3BMaXN0Lm1hcChmdW5jdGlvbiAoc2hvcEl0ZW0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzaG9wSXRlbS5pZCA9PSBpZCkge1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hvcEl0ZW0uaXNPcGVuID0gIXNob3BJdGVtLmlzT3BlbjtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNob3BJdGVtO1xuICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICAgICBzZWxmLnJlbmRlcigpO1xuICAgICAgICAgICAgICAgICAgICBzZWxmLnVwZGF0ZUxvY2FsU3RvcmFnZSgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogUmVtb3ZlIHNob3AgaXRlbSBmcm9tIGxpc3RcbiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGV2ZW50XG4gICAgICAgICAqL1xuICAgICAgICBzZWxmLmNvbXBsZXRlID0gZnVuY3Rpb24gKGV2ZW50KSB7XG4gICAgICAgICAgICB2YXIgdGFyZ2V0ID0gZXZlbnQudGFyZ2V0O1xuICAgICAgICAgICAgdmFyIGlkID0gdGFyZ2V0LmdldEF0dHJpYnV0ZSgnZGF0YS1pZCcpO1xuXG4gICAgICAgICAgICBpZiAoaWQpIHtcblxuICAgICAgICAgICAgICAgIHNlbGYuc2hvcExpc3QgPSBzZWxmLnNob3BMaXN0LmZpbHRlcihmdW5jdGlvbiAoc2hvcEl0ZW0pIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNob3BJdGVtLmlkICE9IGlkO1xuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgc2VsZi5yZW5kZXIoKTtcbiAgICAgICAgICAgICAgICBzZWxmLnVwZGF0ZUxvY2FsU3RvcmFnZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBFZGl0IHNob3AgaXRlbSBjb250ZW50XG4gICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBldmVudFxuICAgICAgICAgKi9cbiAgICAgICAgc2VsZi5lZGl0ID0gZnVuY3Rpb24gKGV2ZW50KSB7XG4gICAgICAgICAgICB2YXIgdGFyZ2V0ID0gZXZlbnQudGFyZ2V0O1xuICAgICAgICAgICAgdmFyIGlkID0gdGFyZ2V0LmdldEF0dHJpYnV0ZSgnZGF0YS1pZCcpO1xuICAgICAgICAgICAgdmFyIHZhbHVlID0gc2VsZi5zaG9wTGlzdC5maW5kKGZ1bmN0aW9uIChzaG9wSXRlbSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBzaG9wSXRlbS5pZCA9PSBpZDtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBpZiAoaWQgJiYgdmFsdWUpIHtcblxuICAgICAgICAgICAgICAgIHNlbGYuaW5wdXQuaWQgPSAnJztcbiAgICAgICAgICAgICAgICBzZWxmLmlucHV0LnZhbHVlID0gdmFsdWUudGl0bGU7XG4gICAgICAgICAgICAgICAgc2VsZi5oaWRkZW4udmFsdWUgPSBpZDtcblxuICAgICAgICAgICAgICAgIHNlbGYuY29udGFpbmVyLmNsYXNzTGlzdC5hZGQoJ3Nob3BMaXN0X3N0YXRlX3ZhbGlkJyk7XG4gICAgICAgICAgICAgICAgc2VsZi5vcGVuRm9vdGVyKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIFNob3cgZm9vdGVyIHdpdGggaW5wdXQgZmllbGRcbiAgICAgICAgICovXG4gICAgICAgIHNlbGYub3BlbkZvb3RlciA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHNlbGYuY29udGFpbmVyLmNsYXNzTGlzdC5hZGQoJ3Nob3BMaXN0X3N0YXRlX2FkZCcpO1xuXG4gICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBzZWxmLmluaXRGb2N1cygpO1xuICAgICAgICAgICAgfSwgMzAwKTtcbiAgICAgICAgfTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogQ2xvc2UgZm9vdGVyIGlmIGNsaWNrIG91dHNpZGUgb2YgZm9vdGVyIGlucHV0XG4gICAgICAgICAqL1xuICAgICAgICBzZWxmLmNsb3NlRm9vdGVyID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgc2VsZi5oaWRlS2V5Ym9hcmQoKTtcblxuICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgc2VsZi5jb250YWluZXIuY2xhc3NMaXN0LnJlbW92ZSgnc2hvcExpc3Rfc3RhdGVfYWRkJyk7XG4gICAgICAgICAgICB9LCA4MDApO1xuICAgICAgICB9O1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBIaWRlIGtleWJvYXJkXG4gICAgICAgICAqL1xuICAgICAgICBzZWxmLmhpZGVLZXlib2FyZCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIGlmIChLZXlib2FyZCkge1xuXG4gICAgICAgICAgICAgICAgS2V5Ym9hcmQuaGlkZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBDaGVjayBpZiBpbnB1dCB2YWx1ZSBsZW5ndGggPiAwIGFuZCBjaGFuZ2UgY29udGFpbmVyIHN0YXRlXG4gICAgICAgICAqL1xuICAgICAgICBzZWxmLmhhbmRsZUtleVVwID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgdmFyIHZhbHVlID0gc2VsZi5pbnB1dC52YWx1ZTtcbiAgICAgICAgICAgIHZhciBsZW5ndGggPSB2YWx1ZS5sZW5ndGg7XG4gICAgICAgICAgICB2YXIgbWV0aG9kID0gbGVuZ3RoID4gMCA/ICdhZGQnIDogJ3JlbW92ZSc7XG5cbiAgICAgICAgICAgIHNlbGYuY29udGFpbmVyLmNsYXNzTGlzdFttZXRob2RdKCdzaG9wTGlzdF9zdGF0ZV92YWxpZCcpO1xuICAgICAgICB9O1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBLZWVwIGlucHV0IGZvY3VzXG4gICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBldmVudFxuICAgICAgICAgKi9cbiAgICAgICAgc2VsZi5oYW5kbGVTdWJtaXRCdG4gPSBmdW5jdGlvbiAoZXZlbnQpIHtcbiAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG5cbiAgICAgICAgICAgIHNlbGYuc3VibWl0KCk7XG4gICAgICAgIH07XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIFNldCBmb2N1cyBvbiBpbnB1dFxuICAgICAgICAgKi9cbiAgICAgICAgc2VsZi5pbml0Rm9jdXMgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBzZWxmLmlucHV0LmZvY3VzKCk7XG4gICAgICAgIH07XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEhhbmRsZSBmb3JtIHN1Ym1pc3Npb24uIEFkZCBuZXcgaXRlbSB0byBzaG9wIGxpc3RcbiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGV2ZW50XG4gICAgICAgICAqL1xuICAgICAgICBzZWxmLnN1Ym1pdCA9IGZ1bmN0aW9uIChldmVudCkge1xuICAgICAgICAgICAgaWYgKGV2ZW50KSB7XG5cbiAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB2YXIgdmFsdWUgPSBzZWxmLmlucHV0LnZhbHVlO1xuICAgICAgICAgICAgdmFyIGhpZGRlblZhbHVlID0gc2VsZi5oaWRkZW4udmFsdWU7XG4gICAgICAgICAgICB2YXIgbGVuZ3RoID0gdmFsdWUubGVuZ3RoO1xuXG4gICAgICAgICAgICBpZiAobGVuZ3RoID09PSAwKSB7XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHZhciBzaG9wTGlzdExlbmd0aCA9IHNlbGYuc2hvcExpc3QubGVuZ3RoO1xuICAgICAgICAgICAgdmFyIGlkID0gaGlkZGVuVmFsdWUgPyBoaWRkZW5WYWx1ZSA6IHNlbGYuc2hvcExpc3QubGVuZ3RoID49IDEgPyBzZWxmLnNob3BMaXN0W3NlbGYuc2hvcExpc3QubGVuZ3RoIC0gMV0uaWQgKyAxIDogMDtcbiAgICAgICAgICAgIHZhciBpc09wZW4gPSBmYWxzZTtcbiAgICAgICAgICAgIHZhciBpdGVtID0gc2VsZi5zaG9wTGlzdC5maW5kKGZ1bmN0aW9uIChzaG9wSXRlbSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBzaG9wSXRlbS5pZCA9PSBpZDtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBpZiAoaXRlbSkge1xuXG4gICAgICAgICAgICAgICAgaXRlbS50aXRsZSA9IHZhbHVlO1xuICAgICAgICAgICAgICAgIHNlbGYuY2xvc2VGb290ZXIoKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG5cbiAgICAgICAgICAgICAgICBzZWxmLnNob3BMaXN0LnB1c2goe1xuICAgICAgICAgICAgICAgICAgICBpZDogaWQsXG4gICAgICAgICAgICAgICAgICAgIHRpdGxlOiB2YWx1ZSxcbiAgICAgICAgICAgICAgICAgICAgaXNPcGVuOiBpc09wZW5cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgc2VsZi5yZXNldCgpO1xuICAgICAgICAgICAgc2VsZi5yZW5kZXIoKTtcbiAgICAgICAgICAgIHNlbGYudXBkYXRlTG9jYWxTdG9yYWdlKCk7XG4gICAgICAgIH07XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIFJlc2V0IGZvcm1cbiAgICAgICAgICovXG4gICAgICAgIHNlbGYucmVzZXQgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBzZWxmLmZvcm0ucmVzZXQoKTtcbiAgICAgICAgICAgIHNlbGYuaW5wdXQuaWQgPSAnc2hvcFZhbHVlJztcbiAgICAgICAgICAgIHNlbGYuaGlkZGVuLnZhbHVlID0gJyc7XG4gICAgICAgICAgICBzZWxmLmNvbnRhaW5lci5jbGFzc0xpc3QucmVtb3ZlKCdzaG9wTGlzdF9zdGF0ZV92YWxpZCcpO1xuICAgICAgICB9O1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBSZW5kZXIgc2hvcCBsaXN0XG4gICAgICAgICAqL1xuICAgICAgICBzZWxmLnJlbmRlciA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHZhciBjb250ZW50TGlzdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3VsJyk7XG5cbiAgICAgICAgICAgIGNvbnRlbnRMaXN0LmNsYXNzTGlzdC5hZGQoJ3Nob3BMaXN0TWFpbl9fbGlzdCcpO1xuXG4gICAgICAgICAgICBzZWxmLnNob3BMaXN0LmZvckVhY2goZnVuY3Rpb24gKGl0ZW0pIHtcbiAgICAgICAgICAgICAgICB2YXIgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2xpJyk7XG5cbiAgICAgICAgICAgICAgICBlbGVtZW50LmNsYXNzTGlzdC5hZGQoJ3Nob3BMaXN0TWFpbl9faXRlbScpO1xuICAgICAgICAgICAgICAgIGVsZW1lbnQuaW5uZXJIVE1MID0gc2VsZi50ZW1wbGF0ZTtcblxuICAgICAgICAgICAgICAgIGVsZW1lbnQucXVlcnlTZWxlY3RvcignLnNob3BMaXN0SXRlbV9fY29udGVudCcpLnNldEF0dHJpYnV0ZSgnZGF0YS1pZCcsIGl0ZW0uaWQpO1xuICAgICAgICAgICAgICAgIGVsZW1lbnQucXVlcnlTZWxlY3RvcignLnNob3BMaXN0SXRlbV9fY29udGVudCcpLmlubmVySFRNTCA9IGl0ZW0udGl0bGU7XG4gICAgICAgICAgICAgICAgZWxlbWVudC5xdWVyeVNlbGVjdG9yKCcuc2hvcExpc3RJdGVtX19idG5fdHlwZV9jb21wbGV0ZScpLnNldEF0dHJpYnV0ZSgnZGF0YS1pZCcsIGl0ZW0uaWQpO1xuICAgICAgICAgICAgICAgIGVsZW1lbnQucXVlcnlTZWxlY3RvcignLnNob3BMaXN0SXRlbV9fYnRuX3R5cGVfZWRpdCcpLnNldEF0dHJpYnV0ZSgnZGF0YS1pZCcsIGl0ZW0uaWQpO1xuXG4gICAgICAgICAgICAgICAgaWYgKGl0ZW0uaXNPcGVuKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgZWxlbWVudC5xdWVyeVNlbGVjdG9yKCcuc2hvcExpc3RJdGVtJykuY2xhc3NMaXN0LmFkZCgnc2hvcExpc3RJdGVtX3N0YXRlX29wZW4nKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBjb250ZW50TGlzdC5hcHBlbmRDaGlsZChlbGVtZW50KTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBzZWxmLmNvbnRlbnQuaW5uZXJIVE1MID0gJyc7XG5cbiAgICAgICAgICAgIHNlbGYuY29udGVudC5hcHBlbmRDaGlsZChjb250ZW50TGlzdCk7XG4gICAgICAgIH07XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIFVwZGF0ZSBsb2NhbCBzdG9yYWdlXG4gICAgICAgICAqL1xuICAgICAgICBzZWxmLnVwZGF0ZUxvY2FsU3RvcmFnZSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHZhciBkYXRhID0gSlNPTi5zdHJpbmdpZnkoc2VsZi5zaG9wTGlzdCk7XG5cbiAgICAgICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKCdzaG9wTGlzdCcsIGRhdGEpO1xuICAgICAgICB9O1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBJbml0IG1vZHVsZVxuICAgICAgICAgKi9cbiAgICAgICAgc2VsZi5pbml0ID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgc2VsZi5nZXRPcHRpb25zKCk7XG4gICAgICAgICAgICBzZWxmLnNldHVwTGlzdGVuZXIoKTtcbiAgICAgICAgICAgIHNlbGYubG9hZERhdGEoKTtcbiAgICAgICAgICAgIHNlbGYucmVuZGVyKCk7XG4gICAgICAgICAgICBzZWxmLmhpZGVLZXlib2FyZCgpO1xuICAgICAgICB9O1xuICAgIH07XG5cbiAgICB2YXIgc2hvcExpc3QgPSBuZXcgU2hvcExpc3QoKTtcblxuICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2RldmljZXJlYWR5JywgZnVuY3Rpb24gKCkge1xuICAgICAgICByZXR1cm4gc2hvcExpc3QuaW5pdCgpO1xuICAgIH0pO1xufSkoKTsiLCIoKCkgPT4ge1xuICAgIC8qKlxuICAgICAqIENyZWF0ZXMgYSBuZXcgU2hvcExpc3QgY2xhc3MuXG4gICAgICogQGNsYXNzXG4gICAgICovXG4gICAgY29uc3QgU2hvcExpc3QgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgY29uc3Qgc2VsZiA9IHRoaXM7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEdldCBvcHRpb25zIGZvciBtb2R1bGVcbiAgICAgICAgICovXG4gICAgICAgIHNlbGYuZ2V0T3B0aW9ucyA9ICgpID0+IHtcbiAgICAgICAgICAgIHNlbGYuY29udGFpbmVyID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLnNob3BMaXN0Jyk7XG4gICAgICAgICAgICBzZWxmLmNvbnRlbnQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcuc2hvcExpc3RNYWluX19jb250ZW50Jyk7XG4gICAgICAgICAgICBzZWxmLnRlbXBsYXRlID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignI3Nob3BMaXN0SXRlbScpLmlubmVySFRNTDtcbiAgICAgICAgICAgIHNlbGYub3BlbkZvb3RlckJ0biA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5zaG9wTGlzdE1haW5fX29wZW4nKTtcbiAgICAgICAgICAgIHNlbGYuZm9vdGVyID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLnNob3BMaXN0Rm9vdGVyJyk7XG4gICAgICAgICAgICBzZWxmLmlucHV0ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLnNob3BMaXN0Rm9vdGVyX19pbnB1dCcpO1xuICAgICAgICAgICAgc2VsZi5oaWRkZW4gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcuc2hvcExpc3RGb290ZXJfX2hpZGRlbicpO1xuICAgICAgICAgICAgc2VsZi5mb3JtID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLnNob3BMaXN0Rm9vdGVyX19mb3JtJyk7XG4gICAgICAgICAgICBzZWxmLnN1Ym1pdEJ0biA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy5zaG9wTGlzdEZvb3Rlcl9fYnRuLnNob3BMaXN0Rm9vdGVyX19idG5fdHlwZV9zdWJtaXQnKTtcbiAgICAgICAgICAgIHNlbGYuc2hvcExpc3QgPSBbXTtcbiAgICAgICAgfTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogQ2hlY2sgaWYgdGhlcmUgZGF0YSBpbiBsb2NhbCBzdG9yYWdlIGFuZCBsb2FkIGl0XG4gICAgICAgICAqL1xuICAgICAgICBzZWxmLmxvYWREYXRhID0gKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgbG9jYWxEYXRhID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oJ3Nob3BMaXN0Jyk7XG5cbiAgICAgICAgICAgIGlmIChsb2NhbERhdGEpIHtcblxuICAgICAgICAgICAgICAgIHNlbGYuc2hvcExpc3QgPSBKU09OLnBhcnNlKGxvY2FsRGF0YSk7XG5cbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogQWRkIGV2ZW50cyBsaXN0ZW5lcnNcbiAgICAgICAgICovXG4gICAgICAgIHNlbGYuc2V0dXBMaXN0ZW5lciA9ICgpID0+IHtcbiAgICAgICAgICAgIHNlbGYub3BlbkZvb3RlckJ0bi5hZGRFdmVudExpc3RlbmVyKCdwb2ludGVyZG93bicsIGV2ZW50ID0+IHtcbiAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuXG4gICAgICAgICAgICAgICAgc2VsZi5vcGVuRm9vdGVyKCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHNlbGYuZm9vdGVyLmFkZEV2ZW50TGlzdGVuZXIoJ3BvaW50ZXJkb3duJywgZXZlbnQgPT4ge1xuICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG5cbiAgICAgICAgICAgICAgICBpZiAoZXZlbnQudGFyZ2V0ID09PSBzZWxmLmZvb3RlciAmJiBzZWxmLmlucHV0LnZhbHVlLmxlbmd0aCA9PT0gMCkge1xuXG4gICAgICAgICAgICAgICAgICAgIHNlbGYuY2xvc2VGb290ZXIoKTtcblxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgc2VsZi5pbnB1dC5hZGRFdmVudExpc3RlbmVyKCdrZXl1cCcsIHNlbGYuaGFuZGxlS2V5VXApO1xuICAgICAgICAgICAgc2VsZi5mb3JtLmFkZEV2ZW50TGlzdGVuZXIoJ3N1Ym1pdCcsIHNlbGYuc3VibWl0KTtcbiAgICAgICAgICAgIHNlbGYuc3VibWl0QnRuLmFkZEV2ZW50TGlzdGVuZXIoJ3BvaW50ZXJkb3duJywgc2VsZi5oYW5kbGVTdWJtaXRCdG4pO1xuICAgICAgICAgICAgc2VsZi5jb250YWluZXIuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBzZWxmLnJvdXRlQ2xpY2spO1xuICAgICAgICB9O1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBSb3V0ZXMgY2xpY2sgZXZlbnRcbiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGV2ZW50XG4gICAgICAgICAqL1xuICAgICAgICBzZWxmLnJvdXRlQ2xpY2sgPSBldmVudCA9PiB7XG4gICAgICAgICAgICBjb25zdCB0YXJnZXQgPSBldmVudC50YXJnZXQ7XG4gICAgICAgICAgICBsZXQgbWV0aG9kID0gJyc7XG5cbiAgICAgICAgICAgIGlmICh0YXJnZXQuY2xhc3NMaXN0LmNvbnRhaW5zKCdzaG9wTGlzdEl0ZW1fX2NvbnRlbnQnKSkge1xuXG4gICAgICAgICAgICAgICAgbWV0aG9kID0gJ3RvZ2dsZUl0ZW1QYW5lbCc7XG5cbiAgICAgICAgICAgIH0gZWxzZSBpZiAodGFyZ2V0LmNsYXNzTGlzdC5jb250YWlucygnc2hvcExpc3RJdGVtX19idG5fdHlwZV9jb21wbGV0ZScpKSB7XG5cbiAgICAgICAgICAgICAgICBtZXRob2QgPSAnY29tcGxldGUnO1xuXG4gICAgICAgICAgICB9IGVsc2UgaWYgKHRhcmdldC5jbGFzc0xpc3QuY29udGFpbnMoJ3Nob3BMaXN0SXRlbV9fYnRuX3R5cGVfZWRpdCcpKSB7XG5cbiAgICAgICAgICAgICAgICBtZXRob2QgPSAnZWRpdCc7XG5cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKG1ldGhvZCkge1xuXG4gICAgICAgICAgICAgICAgc2VsZlttZXRob2RdKGV2ZW50KTtcblxuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBUb2dnbGUgc2hvcCBpdGVtIHBhbmVsXG4gICAgICAgICAqIEBwYXJhbSBldmVudFxuICAgICAgICAgKi9cbiAgICAgICAgc2VsZi50b2dnbGVJdGVtUGFuZWwgPSBldmVudCA9PiB7XG4gICAgICAgICAgICBjb25zdCB0YXJnZXQgPSBldmVudC50YXJnZXQ7XG5cbiAgICAgICAgICAgIGlmICh0YXJnZXQuY2xhc3NMaXN0LmNvbnRhaW5zKCdzaG9wTGlzdEl0ZW1fX2NvbnRlbnQnKSkge1xuXG4gICAgICAgICAgICAgICAgY29uc3QgaWQgPSB0YXJnZXQuZ2V0QXR0cmlidXRlKCdkYXRhLWlkJyk7XG5cbiAgICAgICAgICAgICAgICBpZiAoaWQpIHtcblxuICAgICAgICAgICAgICAgICAgICBzZWxmLnNob3BMaXN0ID0gc2VsZi5zaG9wTGlzdC5tYXAoc2hvcEl0ZW0gPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNob3BJdGVtLmlkID09IGlkKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaG9wSXRlbS5pc09wZW4gPSAhc2hvcEl0ZW0uaXNPcGVuO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBzaG9wSXRlbTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAgICAgc2VsZi5yZW5kZXIoKTtcbiAgICAgICAgICAgICAgICAgICAgc2VsZi51cGRhdGVMb2NhbFN0b3JhZ2UoKTtcblxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBSZW1vdmUgc2hvcCBpdGVtIGZyb20gbGlzdFxuICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gZXZlbnRcbiAgICAgICAgICovXG4gICAgICAgIHNlbGYuY29tcGxldGUgPSBldmVudCA9PiB7XG4gICAgICAgICAgICBjb25zdCB0YXJnZXQgPSBldmVudC50YXJnZXQ7XG4gICAgICAgICAgICBjb25zdCBpZCA9IHRhcmdldC5nZXRBdHRyaWJ1dGUoJ2RhdGEtaWQnKTtcblxuICAgICAgICAgICAgaWYgKGlkKSB7XG5cbiAgICAgICAgICAgICAgICBzZWxmLnNob3BMaXN0ID0gc2VsZi5zaG9wTGlzdC5maWx0ZXIoc2hvcEl0ZW0gPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2hvcEl0ZW0uaWQgIT0gaWQ7XG4gICAgICAgICAgICAgICAgfSk7XG5cblxuICAgICAgICAgICAgICAgIHNlbGYucmVuZGVyKCk7XG4gICAgICAgICAgICAgICAgc2VsZi51cGRhdGVMb2NhbFN0b3JhZ2UoKTtcblxuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBFZGl0IHNob3AgaXRlbSBjb250ZW50XG4gICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBldmVudFxuICAgICAgICAgKi9cbiAgICAgICAgc2VsZi5lZGl0ID0gZXZlbnQgPT4ge1xuICAgICAgICAgICAgY29uc3QgdGFyZ2V0ID0gZXZlbnQudGFyZ2V0O1xuICAgICAgICAgICAgY29uc3QgaWQgPSB0YXJnZXQuZ2V0QXR0cmlidXRlKCdkYXRhLWlkJyk7XG4gICAgICAgICAgICBjb25zdCB2YWx1ZSA9IHNlbGYuc2hvcExpc3QuZmluZChzaG9wSXRlbSA9PiBzaG9wSXRlbS5pZCA9PSBpZCk7XG5cbiAgICAgICAgICAgIGlmIChpZCAmJiB2YWx1ZSkge1xuXG4gICAgICAgICAgICAgICAgc2VsZi5pbnB1dC5pZCA9ICcnO1xuICAgICAgICAgICAgICAgIHNlbGYuaW5wdXQudmFsdWUgPSB2YWx1ZS50aXRsZTtcbiAgICAgICAgICAgICAgICBzZWxmLmhpZGRlbi52YWx1ZSA9IGlkO1xuXG4gICAgICAgICAgICAgICAgc2VsZi5jb250YWluZXIuY2xhc3NMaXN0LmFkZCgnc2hvcExpc3Rfc3RhdGVfdmFsaWQnKTtcbiAgICAgICAgICAgICAgICBzZWxmLm9wZW5Gb290ZXIoKTtcblxuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBTaG93IGZvb3RlciB3aXRoIGlucHV0IGZpZWxkXG4gICAgICAgICAqL1xuICAgICAgICBzZWxmLm9wZW5Gb290ZXIgPSAoKSA9PiB7XG4gICAgICAgICAgICBzZWxmLmNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKCdzaG9wTGlzdF9zdGF0ZV9hZGQnKTtcblxuICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgc2VsZi5pbml0Rm9jdXMoKTtcbiAgICAgICAgICAgIH0sIDMwMCk7XG4gICAgICAgIH07XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIENsb3NlIGZvb3RlciBpZiBjbGljayBvdXRzaWRlIG9mIGZvb3RlciBpbnB1dFxuICAgICAgICAgKi9cbiAgICAgICAgc2VsZi5jbG9zZUZvb3RlciA9ICgpID0+IHtcbiAgICAgICAgICAgIHNlbGYuaGlkZUtleWJvYXJkKCk7XG5cbiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgICAgIHNlbGYuY29udGFpbmVyLmNsYXNzTGlzdC5yZW1vdmUoJ3Nob3BMaXN0X3N0YXRlX2FkZCcpO1xuICAgICAgICAgICAgfSwgODAwKTtcbiAgICAgICAgfTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogSGlkZSBrZXlib2FyZFxuICAgICAgICAgKi9cbiAgICAgICAgc2VsZi5oaWRlS2V5Ym9hcmQgPSAoKSA9PiB7XG4gICAgICAgICAgICBpZiAoS2V5Ym9hcmQpIHtcblxuICAgICAgICAgICAgICAgIEtleWJvYXJkLmhpZGUoKTtcblxuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBDaGVjayBpZiBpbnB1dCB2YWx1ZSBsZW5ndGggPiAwIGFuZCBjaGFuZ2UgY29udGFpbmVyIHN0YXRlXG4gICAgICAgICAqL1xuICAgICAgICBzZWxmLmhhbmRsZUtleVVwID0gKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgdmFsdWUgPSBzZWxmLmlucHV0LnZhbHVlO1xuICAgICAgICAgICAgY29uc3QgbGVuZ3RoID0gdmFsdWUubGVuZ3RoO1xuICAgICAgICAgICAgY29uc3QgbWV0aG9kID0gbGVuZ3RoID4gMCA/ICdhZGQnIDogJ3JlbW92ZSc7XG5cbiAgICAgICAgICAgIHNlbGYuY29udGFpbmVyLmNsYXNzTGlzdFttZXRob2RdKCdzaG9wTGlzdF9zdGF0ZV92YWxpZCcpO1xuICAgICAgICB9O1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBLZWVwIGlucHV0IGZvY3VzXG4gICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBldmVudFxuICAgICAgICAgKi9cbiAgICAgICAgc2VsZi5oYW5kbGVTdWJtaXRCdG4gPSBldmVudCA9PiB7XG4gICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuXG4gICAgICAgICAgICBzZWxmLnN1Ym1pdCgpO1xuICAgICAgICB9O1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBTZXQgZm9jdXMgb24gaW5wdXRcbiAgICAgICAgICovXG4gICAgICAgIHNlbGYuaW5pdEZvY3VzID0gKCkgPT4ge1xuICAgICAgICAgICAgc2VsZi5pbnB1dC5mb2N1cygpO1xuICAgICAgICB9O1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBIYW5kbGUgZm9ybSBzdWJtaXNzaW9uLiBBZGQgbmV3IGl0ZW0gdG8gc2hvcCBsaXN0XG4gICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBldmVudFxuICAgICAgICAgKi9cbiAgICAgICAgc2VsZi5zdWJtaXQgPSBldmVudCA9PiB7XG4gICAgICAgICAgICBpZiAoZXZlbnQpIHtcblxuICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG5cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QgdmFsdWUgPSBzZWxmLmlucHV0LnZhbHVlO1xuICAgICAgICAgICAgY29uc3QgaGlkZGVuVmFsdWUgPSBzZWxmLmhpZGRlbi52YWx1ZTtcbiAgICAgICAgICAgIGNvbnN0IGxlbmd0aCA9IHZhbHVlLmxlbmd0aDtcblxuICAgICAgICAgICAgaWYgKGxlbmd0aCA9PT0gMCkge1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnN0IHNob3BMaXN0TGVuZ3RoID0gc2VsZi5zaG9wTGlzdC5sZW5ndGg7XG4gICAgICAgICAgICBjb25zdCBpZCA9IGhpZGRlblZhbHVlID8gaGlkZGVuVmFsdWUgOiBzZWxmLnNob3BMaXN0Lmxlbmd0aCA+PSAxID8gc2VsZi5zaG9wTGlzdFtzZWxmLnNob3BMaXN0Lmxlbmd0aCAtIDFdLmlkICsgMSA6IDA7XG4gICAgICAgICAgICBjb25zdCBpc09wZW4gPSBmYWxzZTtcbiAgICAgICAgICAgIGNvbnN0IGl0ZW0gPSBzZWxmLnNob3BMaXN0LmZpbmQoc2hvcEl0ZW0gPT4gc2hvcEl0ZW0uaWQgPT0gaWQpO1xuXG4gICAgICAgICAgICBpZiAoaXRlbSkge1xuXG4gICAgICAgICAgICAgICAgaXRlbS50aXRsZSA9IHZhbHVlO1xuICAgICAgICAgICAgICAgIHNlbGYuY2xvc2VGb290ZXIoKTtcblxuICAgICAgICAgICAgfSBlbHNlIHtcblxuICAgICAgICAgICAgICAgIHNlbGYuc2hvcExpc3QucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgIGlkOiBpZCxcbiAgICAgICAgICAgICAgICAgICAgdGl0bGU6IHZhbHVlLFxuICAgICAgICAgICAgICAgICAgICBpc09wZW46IGlzT3BlblxuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHNlbGYucmVzZXQoKTtcbiAgICAgICAgICAgIHNlbGYucmVuZGVyKCk7XG4gICAgICAgICAgICBzZWxmLnVwZGF0ZUxvY2FsU3RvcmFnZSgpO1xuICAgICAgICB9O1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBSZXNldCBmb3JtXG4gICAgICAgICAqL1xuICAgICAgICBzZWxmLnJlc2V0ID0gKCkgPT4ge1xuICAgICAgICAgICAgc2VsZi5mb3JtLnJlc2V0KCk7XG4gICAgICAgICAgICBzZWxmLmlucHV0LmlkID0gJ3Nob3BWYWx1ZSc7XG4gICAgICAgICAgICBzZWxmLmhpZGRlbi52YWx1ZSA9ICcnO1xuICAgICAgICAgICAgc2VsZi5jb250YWluZXIuY2xhc3NMaXN0LnJlbW92ZSgnc2hvcExpc3Rfc3RhdGVfdmFsaWQnKTtcbiAgICAgICAgfTtcblxuICAgICAgICAvKipcbiAgICAgICAgICogUmVuZGVyIHNob3AgbGlzdFxuICAgICAgICAgKi9cbiAgICAgICAgc2VsZi5yZW5kZXIgPSAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBjb250ZW50TGlzdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3VsJyk7XG5cbiAgICAgICAgICAgIGNvbnRlbnRMaXN0LmNsYXNzTGlzdC5hZGQoJ3Nob3BMaXN0TWFpbl9fbGlzdCcpO1xuXG4gICAgICAgICAgICBzZWxmLnNob3BMaXN0LmZvckVhY2goZnVuY3Rpb24oaXRlbSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdsaScpO1xuXG4gICAgICAgICAgICAgICAgZWxlbWVudC5jbGFzc0xpc3QuYWRkKCdzaG9wTGlzdE1haW5fX2l0ZW0nKTtcbiAgICAgICAgICAgICAgICBlbGVtZW50LmlubmVySFRNTCA9IHNlbGYudGVtcGxhdGU7XG5cbiAgICAgICAgICAgICAgICBlbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJy5zaG9wTGlzdEl0ZW1fX2NvbnRlbnQnKS5zZXRBdHRyaWJ1dGUoJ2RhdGEtaWQnLCBpdGVtLmlkKTtcbiAgICAgICAgICAgICAgICBlbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJy5zaG9wTGlzdEl0ZW1fX2NvbnRlbnQnKS5pbm5lckhUTUwgPSBpdGVtLnRpdGxlO1xuICAgICAgICAgICAgICAgIGVsZW1lbnQucXVlcnlTZWxlY3RvcignLnNob3BMaXN0SXRlbV9fYnRuX3R5cGVfY29tcGxldGUnKS5zZXRBdHRyaWJ1dGUoJ2RhdGEtaWQnLCBpdGVtLmlkKTtcbiAgICAgICAgICAgICAgICBlbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJy5zaG9wTGlzdEl0ZW1fX2J0bl90eXBlX2VkaXQnKS5zZXRBdHRyaWJ1dGUoJ2RhdGEtaWQnLCBpdGVtLmlkKTtcblxuICAgICAgICAgICAgICAgIGlmIChpdGVtLmlzT3Blbikge1xuXG4gICAgICAgICAgICAgICAgICAgIGVsZW1lbnQucXVlcnlTZWxlY3RvcignLnNob3BMaXN0SXRlbScpLmNsYXNzTGlzdC5hZGQoJ3Nob3BMaXN0SXRlbV9zdGF0ZV9vcGVuJyk7XG5cbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBjb250ZW50TGlzdC5hcHBlbmRDaGlsZChlbGVtZW50KTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBzZWxmLmNvbnRlbnQuaW5uZXJIVE1MID0gJyc7XG5cbiAgICAgICAgICAgIHNlbGYuY29udGVudC5hcHBlbmRDaGlsZChjb250ZW50TGlzdCk7XG4gICAgICAgIH07XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIFVwZGF0ZSBsb2NhbCBzdG9yYWdlXG4gICAgICAgICAqL1xuICAgICAgICBzZWxmLnVwZGF0ZUxvY2FsU3RvcmFnZSA9ICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGRhdGEgPSBKU09OLnN0cmluZ2lmeShzZWxmLnNob3BMaXN0KTtcblxuICAgICAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ3Nob3BMaXN0JywgZGF0YSk7XG4gICAgICAgIH07XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqIEluaXQgbW9kdWxlXG4gICAgICAgICAqL1xuICAgICAgICBzZWxmLmluaXQgPSAoKSA9PiB7XG4gICAgICAgICAgICBzZWxmLmdldE9wdGlvbnMoKTtcbiAgICAgICAgICAgIHNlbGYuc2V0dXBMaXN0ZW5lcigpO1xuICAgICAgICAgICAgc2VsZi5sb2FkRGF0YSgpO1xuICAgICAgICAgICAgc2VsZi5yZW5kZXIoKTtcbiAgICAgICAgICAgIHNlbGYuaGlkZUtleWJvYXJkKCk7XG4gICAgICAgIH07XG4gICAgfTtcblxuICAgIGNvbnN0IHNob3BMaXN0ID0gbmV3IFNob3BMaXN0KCk7XG5cbiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdkZXZpY2VyZWFkeScsICgpID0+IHNob3BMaXN0LmluaXQoKSk7XG59KSgpO1xuIl19
